name: Build and Release

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libgcrypt20-dev \
            libatk1.0-dev libx11-xcb-dev libxcb-dri3-dev \
            libxcb-present-dev libxshmfence-dev \
            libasound2-dev libnss3-dev libfuse2

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install fastforge
        run: dart pub global activate fastforge

      - name: Download CEF SDK
        run: bash scripts/download_cef.sh

      - name: Build CEF Wrapper
        run: bash scripts/build_cef_wrapper.sh

      - name: Distribute AppImage
        run: |
          # Fastforge might need libapp.so in specific place or it handles it.
          # Since we have a custom CEF integration, we might still need to bundle manually 
          # IF fastforge doesn't pick up the custom CEF libs.
          # Let's try standard fastforge first.
          export PATH="$PATH":"$HOME/.pub-cache/bin"
          fastforge distribute --release-name production --job-name release-linux

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: danger-browser-appimage
          path: dist/production/**/*