name: Build and Release

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libgcrypt20-dev \
            libatk1.0-dev libx11-xcb-dev libxcb-dri3-dev \
            libxcb-present-dev libxshmfence-dev \
            libasound2-dev libnss3-dev libfuse2

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Download CEF SDK
        run: bash scripts/download_cef.sh

      - name: Build CEF Wrapper
        run: bash scripts/build_cef_wrapper.sh

      - name: Flutter build Linux
        run: flutter build linux --release

      - name: Prepare AppImage (AppDir)
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/lib
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          
          # Move Flutter bundle to AppDir bin
          mv build/linux/x64/release/bundle/* AppDir/usr/bin/
          rm -rf build/ # Clear space
          
          # Bundle CEF - Move libcef.so to usr/lib
          mv AppDir/usr/bin/lib/* AppDir/usr/lib/
          rmdir AppDir/usr/bin/lib
          
          # Move libapp.so to usr/lib
          find AppDir/usr/bin -name "libapp.so" -exec mv {} AppDir/usr/lib/ \;
          
          cp -P -r linux/cef/sdk/Release/libcef.so AppDir/usr/lib/
          cp -P -r linux/cef/sdk/Resources/* AppDir/usr/bin/
          
          # Create Desktop Entry
          cat > AppDir/danger_browser.desktop <<EOF
          [Desktop Entry]
          Name=DangerBrowser
          Exec=danger_browser
          Icon=danger_browser
          Type=Application
          Categories=Network;WebBrowser;
          EOF
          
          # Create AppRun script - Absolute paths inside AppImage
          cat > AppDir/AppRun <<EOF
          #!/bin/sh
          HERE="\$(dirname "\$(readlink -f "\$0")")"
          export PATH="\$HERE/usr/bin:\$PATH"
          export LD_LIBRARY_PATH="\$HERE/usr/lib:\$HERE/usr/bin/lib:\$HERE/usr/bin:\$LD_LIBRARY_PATH"
          
          # Debug: check if libapp exists
          if [ ! -f "\$HERE/usr/lib/libapp.so" ]; then
            echo "Error: \$HERE/usr/lib/libapp.so not found"
            exit 1
          fi
          
          exec "\$HERE/usr/bin/danger_browser" --aot-shared-library-name="\$HERE/usr/lib/libapp.so" "\$@"
          EOF
          chmod +x AppDir/AppRun
          
          # Use placeholder icon
          cp web/icons/Icon-192.png AppDir/danger_browser.png
          cp web/icons/Icon-192.png AppDir/usr/share/icons/hicolor/256x256/apps/danger_browser.png

      - name: Build AppImage
        run: |
          rm -rf linux/cef/sdk/ # Free massive space before mksquashfs
          wget -O appimagetool https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool
          ./appimagetool --appimage-extract-and-run AppDir DangerBrowser-x86_64.AppImage

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: danger-browser-appimage
          path: DangerBrowser-x86_64.AppImage