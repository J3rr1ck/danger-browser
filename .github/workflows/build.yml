name: Build and Release

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libgcrypt20-dev \
            libatk1.0-dev libx11-xcb-dev libxcb-dri3-dev \
            libxcb-present-dev libxshmfence-dev \
            libasound2-dev libnss3-dev libfuse2

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Download CEF SDK
        run: bash scripts/download_cef.sh

      - name: Build CEF Wrapper
        run: bash scripts/build_cef_wrapper.sh

      - name: Flutter build Linux
        run: flutter build linux --release

      - name: Prepare AppImage (AppDir)
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/lib
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          
          echo "Listing build bundle:"
          ls -R build/linux/x64/release/bundle/
          
          # Copy Flutter bundle to AppDir
          cp -r build/linux/x64/release/bundle/* AppDir/usr/bin/
          
          # Copy CEF SDK release files to usr/lib
          echo "Copying CEF libs..."
          cp -r linux/cef/sdk/Release/* AppDir/usr/lib/
          cp -r linux/cef/sdk/Resources/* AppDir/usr/bin/
          
          # Create Desktop Entry
          cat > AppDir/danger_browser.desktop <<EOF
          [Desktop Entry]
          Name=DangerBrowser
          Exec=danger_browser
          Icon=danger_browser
          Type=Application
          Categories=Network;WebBrowser;
          EOF
          
          # Create AppRun script
          cat > AppDir/AppRun <<EOF
          #!/bin/sh
          SELF=\$(readlink -f "\$0")
          HERE=\${SELF%/*}
          export PATH="\$HERE/usr/bin:\$PATH"
          export LD_LIBRARY_PATH="\$HERE/usr/bin/lib:\$HERE/usr/lib:\$HERE/usr/bin:\$LD_LIBRARY_PATH"
          exec "\$HERE/usr/bin/danger_browser" "\$@"
          EOF
          chmod +x AppDir/AppRun
          
          echo "AppRun content:"
          cat AppDir/AppRun
          
          # Use a placeholder icon from Flutter web assets for now
          cp web/icons/Icon-192.png AppDir/danger_browser.png
          cp web/icons/Icon-192.png AppDir/usr/share/icons/hicolor/256x256/apps/danger_browser.png

      - name: Build AppImage
        run: |
          wget -O appimagetool https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool
          ./appimagetool --appimage-extract-and-run AppDir DangerBrowser-x86_64.AppImage

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: danger-browser-appimage
          path: DangerBrowser-x86_64.AppImage